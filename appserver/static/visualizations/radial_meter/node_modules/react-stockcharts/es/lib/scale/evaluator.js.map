{"version":3,"sources":["../../../../src/lib/scale/evaluator.js"],"names":["first","last","getClosestItemIndexes","isNotDefined","getLogger","log","extentsWrapper","xAccessor","useWholeData","clamp","pointsPerPxThreshold","minPointsPerPxThreshold","domain","data","inputDomain","initialXScale","currentPlotData","currentDomain","plotData","left","right","filteredData","getFilteredResponse","clampedDomain","Math","max","min","realInputDomain","xScale","copy","width","floor","chartWidth","range","length","showMax","canShowTheseManyPeriods","slice","newXScale","newWidth","arrayLength","maxThreshold","minThreshold","showMinThreshold","showMaxThreshold","threshold","ceil","newLeftIndex","newRightIndex","invert"],"mappings":"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","file":"evaluator.js","sourcesContent":["\"use strict\";\n\nimport {\n\tfirst,\n\tlast,\n\tgetClosestItemIndexes,\n\tisNotDefined,\n\tgetLogger,\n} from \"../utils\";\n\nconst log = getLogger(\"evaluator\");\n\nfunction extentsWrapper(xAccessor, useWholeData, clamp, pointsPerPxThreshold, minPointsPerPxThreshold) {\n\tfunction domain(data, inputDomain, xAccessor, initialXScale, currentPlotData, currentDomain) {\n\t\tif (useWholeData) {\n\t\t\treturn { plotData: data, domain: inputDomain };\n\t\t}\n\n\t\tconst left = first(inputDomain);\n\t\tconst right = last(inputDomain);\n\n\t\tconst filteredData = getFilteredResponse(data, left, right, xAccessor);\n\t\tconst clampedDomain = [\n\t\t\tMath.max(left, xAccessor(first(data))),\n\t\t\tMath.min(right, xAccessor(last(data)))\n\t\t];\n\n\t\tconst realInputDomain = xAccessor === xAccessor\n\t\t\t? (clamp ? clampedDomain : inputDomain)\n\t\t\t: [xAccessor(first(filteredData)), xAccessor(last(filteredData))];\n\n\t\tconst xScale = initialXScale.copy().domain(realInputDomain);\n\n\t\tconst width = Math.floor(xScale(xAccessor(last(filteredData)))\n\t\t\t- xScale(xAccessor(first(filteredData))));\n\n\t\tlet plotData, domain;\n\n\t\tconst chartWidth = last(xScale.range()) - first(xScale.range());\n\n\t\tlog(`Trying to show ${filteredData.length} in ${width}px,`\n\t\t\t+ ` I can show up to ${showMax(width, pointsPerPxThreshold)} in that width. `\n\t\t\t+ `Also FYI the entire chart width is ${chartWidth}px and pointsPerPxThreshold is ${pointsPerPxThreshold}`);\n\n\t\tif (canShowTheseManyPeriods(width, filteredData.length, pointsPerPxThreshold, minPointsPerPxThreshold)) {\n\t\t\tplotData = filteredData;\n\t\t\tdomain = realInputDomain;\n\t\t\tlog(\"AND IT WORKED\");\n\t\t} else {\n\t\t\tplotData = currentPlotData || filteredData.slice(filteredData.length - showMax(width, pointsPerPxThreshold));\n\t\t\tdomain = currentDomain || [xAccessor(first(plotData)), xAccessor(last(plotData))];\n\n\t\t\tconst newXScale = xScale.copy().domain(domain);\n\t\t\tconst newWidth = Math.floor(newXScale(xAccessor(last(plotData)))\n\t\t\t\t- newXScale(xAccessor(first(plotData))));\n\n\t\t\tlog(`and ouch, that is too much, so instead showing ${plotData.length} in ${newWidth}px`);\n\t\t}\n\n\t\treturn { plotData, domain };\n\t}\n\treturn domain;\n}\n\nfunction canShowTheseManyPeriods(width, arrayLength, maxThreshold, minThreshold) {\n\treturn arrayLength > showMinThreshold(width, minThreshold) && arrayLength < showMaxThreshold(width, maxThreshold);\n}\n\nfunction showMinThreshold(width, threshold) {\n\treturn Math.max(1, Math.ceil(width * threshold));\n}\n\nfunction showMaxThreshold(width, threshold) {\n\treturn Math.floor(width * threshold);\n}\n\nfunction showMax(width, threshold) {\n\treturn Math.floor(showMaxThreshold(width, threshold) * 0.97);\n}\n\nfunction getFilteredResponse(data, left, right, xAccessor) {\n\tconst newLeftIndex = getClosestItemIndexes(data, left, xAccessor).right;\n\tconst newRightIndex = getClosestItemIndexes(data, right, xAccessor).left;\n\n\tconst filteredData = data.slice(newLeftIndex, newRightIndex + 1);\n\t// console.log(right, newRightIndex, dataForInterval.length);\n\n\treturn filteredData;\n}\n\nexport default function({\n\txAccessor, xScale, useWholeData, clamp,\n\tpointsPerPxThreshold, minPointsPerPxThreshold,\n}) {\n\treturn extentsWrapper(\n\t\txAccessor,\n\t\tuseWholeData || isNotDefined(xScale.invert),\n\t\tclamp,\n\t\tpointsPerPxThreshold,\n\t\tminPointsPerPxThreshold\n\t);\n}\n"]}