{"version":3,"sources":["../../../src/lib/scale/evaluator.js"],"names":["xAccessor","xScale","useWholeData","clamp","pointsPerPxThreshold","minPointsPerPxThreshold","extentsWrapper","invert","log","domain","data","inputDomain","initialXScale","currentPlotData","currentDomain","plotData","left","right","filteredData","getFilteredResponse","clampedDomain","Math","max","min","realInputDomain","copy","width","floor","chartWidth","range","length","showMax","canShowTheseManyPeriods","slice","newXScale","newWidth","arrayLength","maxThreshold","minThreshold","showMinThreshold","showMaxThreshold","threshold","ceil","newLeftIndex","newRightIndex"],"mappings":"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","file":"evaluator.js","sourcesContent":["\"use strict\";\n\nimport {\n\tfirst,\n\tlast,\n\tgetClosestItemIndexes,\n\tisNotDefined,\n\tgetLogger,\n} from \"../utils\";\n\nconst log = getLogger(\"evaluator\");\n\nfunction extentsWrapper(xAccessor, useWholeData, clamp, pointsPerPxThreshold, minPointsPerPxThreshold) {\n\tfunction domain(data, inputDomain, xAccessor, initialXScale, currentPlotData, currentDomain) {\n\t\tif (useWholeData) {\n\t\t\treturn { plotData: data, domain: inputDomain };\n\t\t}\n\n\t\tconst left = first(inputDomain);\n\t\tconst right = last(inputDomain);\n\n\t\tconst filteredData = getFilteredResponse(data, left, right, xAccessor);\n\t\tconst clampedDomain = [\n\t\t\tMath.max(left, xAccessor(first(data))),\n\t\t\tMath.min(right, xAccessor(last(data)))\n\t\t];\n\n\t\tconst realInputDomain = xAccessor === xAccessor\n\t\t\t? (clamp ? clampedDomain : inputDomain)\n\t\t\t: [xAccessor(first(filteredData)), xAccessor(last(filteredData))];\n\n\t\tconst xScale = initialXScale.copy().domain(realInputDomain);\n\n\t\tconst width = Math.floor(xScale(xAccessor(last(filteredData)))\n\t\t\t- xScale(xAccessor(first(filteredData))));\n\n\t\tlet plotData, domain;\n\n\t\tconst chartWidth = last(xScale.range()) - first(xScale.range());\n\n\t\tlog(`Trying to show ${filteredData.length} in ${width}px,`\n\t\t\t+ ` I can show up to ${showMax(width, pointsPerPxThreshold)} in that width. `\n\t\t\t+ `Also FYI the entire chart width is ${chartWidth}px and pointsPerPxThreshold is ${pointsPerPxThreshold}`);\n\n\t\tif (canShowTheseManyPeriods(width, filteredData.length, pointsPerPxThreshold, minPointsPerPxThreshold)) {\n\t\t\tplotData = filteredData;\n\t\t\tdomain = realInputDomain;\n\t\t\tlog(\"AND IT WORKED\");\n\t\t} else {\n\t\t\tplotData = currentPlotData || filteredData.slice(filteredData.length - showMax(width, pointsPerPxThreshold));\n\t\t\tdomain = currentDomain || [xAccessor(first(plotData)), xAccessor(last(plotData))];\n\n\t\t\tconst newXScale = xScale.copy().domain(domain);\n\t\t\tconst newWidth = Math.floor(newXScale(xAccessor(last(plotData)))\n\t\t\t\t- newXScale(xAccessor(first(plotData))));\n\n\t\t\tlog(`and ouch, that is too much, so instead showing ${plotData.length} in ${newWidth}px`);\n\t\t}\n\n\t\treturn { plotData, domain };\n\t}\n\treturn domain;\n}\n\nfunction canShowTheseManyPeriods(width, arrayLength, maxThreshold, minThreshold) {\n\treturn arrayLength > showMinThreshold(width, minThreshold) && arrayLength < showMaxThreshold(width, maxThreshold);\n}\n\nfunction showMinThreshold(width, threshold) {\n\treturn Math.max(1, Math.ceil(width * threshold));\n}\n\nfunction showMaxThreshold(width, threshold) {\n\treturn Math.floor(width * threshold);\n}\n\nfunction showMax(width, threshold) {\n\treturn Math.floor(showMaxThreshold(width, threshold) * 0.97);\n}\n\nfunction getFilteredResponse(data, left, right, xAccessor) {\n\tconst newLeftIndex = getClosestItemIndexes(data, left, xAccessor).right;\n\tconst newRightIndex = getClosestItemIndexes(data, right, xAccessor).left;\n\n\tconst filteredData = data.slice(newLeftIndex, newRightIndex + 1);\n\t// console.log(right, newRightIndex, dataForInterval.length);\n\n\treturn filteredData;\n}\n\nexport default function({\n\txAccessor, xScale, useWholeData, clamp,\n\tpointsPerPxThreshold, minPointsPerPxThreshold,\n}) {\n\treturn extentsWrapper(\n\t\txAccessor,\n\t\tuseWholeData || isNotDefined(xScale.invert),\n\t\tclamp,\n\t\tpointsPerPxThreshold,\n\t\tminPointsPerPxThreshold\n\t);\n}\n"]}